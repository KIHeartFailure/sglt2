```{r outtabsubef, cache=cacheon}
survmysub <- function(time, event, eventname) {
  out <- data.frame(matrix(NA, ncol = 4, nrow = 4))
  colnames(out) <- c("Outcome", "Subgroup", "HR (95% CI), p-value", "p for interaction")
  out[1, 1] <- eventname

  levsef <- levels(matchp %>% pull(shf_ef_cat))

  for (i in seq_along(levsef)) {
    amod <- with(imp, coxph(formula(paste0(
      "Surv(", time, ",", event, " == 'Yes') ~ ddr_sglt2 * relevel(shf_ef_cat, ref = '", levsef[i], "') +",
      paste(modvars[modvars != "shf_ef_cat"], collapse = " + ")
    ))))

    ## df the number of events minus the regression coefficients.
    ## There is support for this from middle of page 149 of the book by Parmer & Machin (ISBN 0471936405)
    asmod <- summary(pool(amod,
      dfcom =
        (amod$analyses[[1]]$nevent - length(amod$analyses[[1]]$coefficients))
    ))

    out[1 + i, 2] <- levsef[i]
    out[1 + i, 3] <- paste0(
      dF(exp(asmod$estimate[1]), dig = 2),
      " (", dF(exp(asmod$estimate[1] - z05 * asmod$std.error[1]), dig = 2),
      "-", dF(exp(asmod$estimate[1] + z05 * asmod$std.error[1]), dig = 2), "), ",
      dF(asmod$p.value[1], dig = 3, p = TRUE)
    )


    if (i == 1) {
      pint <- with(imp, car::Anova(coxph(formula(paste0(
        "Surv(", time, ",", event, " == 'Yes') ~ ddr_sglt2 * relevel(shf_ef_cat, ref = '", levsef[i], "') +",
        paste(modvars[modvars != "shf_ef_cat"], collapse = " + ")
      ))),
      type = "III", test.statistic = "Wald"
      ))

      nc <- length(pint$analyses[[1]]$Chisq)

      chis2 <- c(
        pint$analyses[[1]]$Chisq[nc],
        pint$analyses[[2]]$Chisq[nc],
        pint$analyses[[3]]$Chisq[nc],
        pint$analyses[[4]]$Chisq[nc],
        pint$analyses[[5]]$Chisq[nc],
        pint$analyses[[6]]$Chisq[nc],
        pint$analyses[[7]]$Chisq[nc],
        pint$analyses[[8]]$Chisq[nc],
        pint$analyses[[9]]$Chisq[nc],
        pint$analyses[[10]]$Chisq[nc]
      )

      dk.comb <- dF(miceadds::micombine.chisquare(
        dk = chis2, df = pint$analyses[[1]]$Df[nc],
        display = FALSE
      )[2], dig = 3, p = TRUE)

      out[1, 4] <- dk.comb
    }
  }
  return(out)
}

cvdeathhfhosp <- survmysub(
  time = "sos_outtime_hosphf",
  event = "sos_out_deathcvhosphf",
  eventname = "CVD/1 HF hosp"
)

deathhfhosp <- survmysub(
  time = "sos_outtime_hosphf",
  event = "sos_out_deathhosphf",
  eventname = "All-cause mortality/1 HF hosp"
)

outall <- rbind(
  cvdeathhfhosp,
  deathhfhosp
)

write.xlsx(outall, paste0("./output/tabs/outtabsubgroupef_", Sys.Date(), ".xlsx"), rowNames = FALSE)

mykable(outall,
  fontsize = 6,
  caption = "Outcomes - Subgroup EF"
)
```

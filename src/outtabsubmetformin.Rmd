```{r outtabsubmet, cache=cacheon}
survmymet <- function(time, event, eventname) {
  out <- data.frame(matrix(NA, ncol = 2, nrow = 1))
  colnames(out) <- c("Outcome", "HR (95% CI), p-value")

  out[1, 1] <- eventname

  # adjusted individual covariates
  amod <- my.coxph.mids(formula(paste0(
    "Surv(", time, ",", event, " == 'Yes') ~ ddr_metformin +",
    paste(modvarsstrata, collapse = " + ")
  )),
  data = imp, subset = quote(ddr_sglt2 == "Yes")
  )

  ## df the number of events minus the regression coefficients.
  ## There is support for this from middle of page 149 of the book by Parmer & Machin (ISBN 0471936405)
  asmod <- summary(pool(amod,
    dfcom =
      (amod$analyses[[1]]$nevent - length(amod$analyses[[1]]$coefficients))
  ))

  out[1, 2] <- paste0(
    dF(exp(asmod$estimate[1]), dig = 2),
    " (", dF(exp(asmod$estimate[1] - z05 * asmod$std.error[1]), dig = 2),
    "-", dF(exp(asmod$estimate[1] + z05 * asmod$std.error[1]), dig = 2), "), ",
    dF(asmod$p.value[1], dig = 3, p = TRUE)
  )

  return(out)
}

cvdeathhfhosp <- survmymet(
  time = "sos_outtime_hosphf",
  event = "sos_out_deathcvhosphf",
  eventname = "CVD/1 HF hosp"
)

deathhfhosp <- survmymet(
  time = "sos_outtime_hosphf",
  event = "sos_out_deathhosphf",
  eventname = "All-cause mortality/1 HF hosp"
)

outall <- rbind(
  cvdeathhfhosp,
  deathhfhosp
)

write.xlsx(outall, paste0("./output/tabs/outtabmetformin_", Sys.Date(), ".xlsx"), rowNames = FALSE)

mykable(outall,
  fontsize = 6,
  caption = "Outcomes - Metformin"
)
```
